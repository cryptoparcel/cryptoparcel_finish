{% extends 'base.html' %}
{% block title %}Create Shipping Label — CryptoParcel{% endblock %}
{% block content %}

<section class="section">
  <div class="page-header">
    <div>
      <h1>Create a Shipping Label</h1>
      <p>Fill in the sender and recipient details, choose a service, and we’ll handle the rest.</p>
    </div>
    <div class="page-meta">
      <div class="meta-item">
        <span class="meta-label">Wallet balance</span>
        <span class="meta-value">${{ (current_user.balance_usd or 0.0) | round(2) }}</span>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: FORM -->
    <section class="card card-main">
      <form method="POST" class="form">
  {{ form.csrf_token }}

  <!-- SERVICE & WEIGHT -->
  <div class="section">
    <h2>Service &amp; Package</h2>
    <div class="grid-2">
      <div class="field">
        <label for="service">Service</label>
        <select id="service" name="service" required>
          <optgroup label="USPS">
            <option value="USPS First-Class">USPS First-Class</option>
            <option value="USPS Priority Mail">USPS Priority Mail</option>
            <option value="USPS Priority Mail Express">USPS Priority Mail Express</option>
          </optgroup>
          <optgroup label="UPS">
            <option value="UPS Ground">UPS Ground</option>
            <option value="UPS 2nd Day Air">UPS 2nd Day Air</option>
            <option value="UPS Next Day Air Saver">UPS Next Day Air Saver</option>
          </optgroup>
          <optgroup label="FedEx">
            <option value="FedEx Ground">FedEx Ground</option>
            <option value="FedEx Express Saver">FedEx Express Saver</option>
            <option value="FedEx 2Day">FedEx 2Day</option>
            <option value="FedEx Standard Overnight">FedEx Standard Overnight</option>
          </optgroup>
        </select>
        <p class="help">More premium services will cost slightly more.</p>
      </div>

      <div class="field">
        <label for="weight_oz">Package Weight (oz)</label>
        <input id="weight_oz" type="number" step="0.1" min="0.1" name="weight_oz" placeholder="e.g. 12.5" required />
        <p class="help">Use ounces (1 lb = 16 oz).</p>
      </div>
    </div>
  </div>

  <!-- FROM ADDRESS -->
  <div class="section">
    <h2>From Address</h2>

    {% if from_profiles %}
    <div class="field">
      <label for="from_profile_select">Saved sender profiles</label>
      <select id="from_profile_select">
        <option value="">— Select saved from address —</option>
        {% for p in from_profiles %}
        <option
          value="{{ p.id }}"
          data-name="{{ p.name or '' }}"
          data-street1="{{ p.street1 }}"
          data-street2="{{ p.street2 or '' }}"
          data-city="{{ p.city }}"
          data-state="{{ p.state }}"
          data-zip="{{ p.zip }}"
        >
          {{ p.label }} ({{ p.city }}, {{ p.state }})
        </option>
        {% endfor %}
      </select>
      <p class="help">Choose a saved sender profile to auto-fill the fields below.</p>
    </div>
    {% endif %}

    <div class="grid-2">
      <div class="field">
        <label for="from_name">Name</label>
        <input id="from_name" name="from_name" type="text" required />
      </div>
      <div class="field">
        <label for="from_street1">Street</label>
        <input id="from_street1" name="from_street1" type="text" required />
      </div>
    </div>
    <div c<!-- TO ADDRESS -->
  <div class="section">
    <h2>To Address</h2>

    {% if to_profiles %}
    <div class="field">
      <label for="to_profile_select">Saved recipient profiles</label>
      <select id="to_profile_select">
        <option value="">— Select saved to address —</option>
        {% for p in to_profiles %}
        <option
          value="{{ p.id }}"
          data-name="{{ p.name or '' }}"
          data-street1="{{ p.street1 }}"
          data-street2="{{ p.street2 or '' }}"
          data-city="{{ p.city }}"
          data-state="{{ p.state }}"
          data-zip="{{ p.zip }}"
        >
          {{ p.label }} ({{ p.city }}, {{ p.state }})
        </option>
        {% endfor %}
      </select>
      <p class="help">Pick a saved destination to auto-fill.</p>
    </div>
    {% endif %}

    <div class="grid-2">
      <div class="field">
        <label for="to_name">Name</label>
        <input id="to_name" name="to_name" type="text" required />
      </div>
      <div class="field">
        <label for="to_street1">Street</label>
        <input id="to_street1" name="to_street1" type="text" required />
      </div>
    </div>
    <div class="grid-2">
      <div class="field">
        <label for="to_street2">Apt/Suite (optional)</label>
        <input id="to_street2" name="to_street2" type="text" />
      </div>
    </div>
    <div class="grid-3">
      <div class="field">
        <label for="to_city">City</label>
        <input id="to_city" name="to_city" type="text" required />
      </div>
      <div class="field">
        <label for="to_state">State</label>
        <input id="to_state" name="to_state" maxlength="2" placeholder="TX" type="text" required />
      </div>
      <div class="field">
        <label for="to_zip">ZIP</label>
        <input id="to_zip" name="to_zip" pattern="\d{5}(-\d{4})?" title="5 or 9-digit ZIP" required />
      </div>
    </div>
  </div>

  <!-- REFERENCE -->
  <div class="section">
    <h2>Reference (Optional)</h2>
    <div class="field">
      <label for="reference">Order ID, notes, etc.</label>
      <input id="reference" name="reference" type="text" placeholder="e.g. Amazon returns, Box #3" maxlength="100" />
    </div>
  </div>

  <!-- SUBMIT -->
  <div class="actions">
    <button type="submit" class="btn primary">Generate Label &amp; Continue</button>
    <p class="help">
      We’ll calculate the label price automatically.
      If your wallet balance is high enough, we’ll use it first.
      Otherwise you’ll be redirected to pay with crypto via NOWPayments.
    </p>
  </div>
</form>
    </section>

    <!-- RIGHT: INFO SIDEBAR -->
    <aside class="card card-side">
      <h2>How Payment Works</h2>
      <ol class="list">
        <li>We calculate a simple placeholder rate based on service + weight.</li>
        <li>If your wallet balance covers it, we auto-charge your wallet.</li>
        <li>If not, you’ll be redirected to a crypto checkout.</li>
      </ol>
      <div class="info-box">
        <p><strong>Tip:</strong> You can top up your wallet anytime on the Wallet page using crypto.</p>
      </div>
    </aside>
  </div>
</section>



<script>
document.addEventListener("DOMContentLoaded", function () {
  function applyAddressProfile(selectId, prefix) {
    var selectEl = document.getElementById(selectId);
    if (!selectEl) return;
    selectEl.addEventListener("change", function () {
      var opt = selectEl.options[selectEl.selectedIndex];
      if (!opt || !opt.value) return;

      var name = opt.getAttribute("data-name") || "";
      var street1 = opt.getAttribute("data-street1") || "";
      var street2 = opt.getAttribute("data-street2") || "";
      var city = opt.getAttribute("data-city") || "";
      var state = opt.getAttribute("data-state") || "";
      var zip = opt.getAttribute("data-zip") || "";

      var nameInput = document.getElementById(prefix + "_name");
      var street1Input = document.getElementById(prefix + "_street1");
      var street2Input = document.getElementById(prefix + "_street2");
      var cityInput = document.getElementById(prefix + "_city");
      var stateInput = document.getElementById(prefix + "_state");
      var zipInput = document.getElementById(prefix + "_zip");

      if (nameInput) nameInput.value = name;
      if (street1Input) street1Input.value = street1;
      if (street2Input) street2Input.value = street2;
      if (cityInput) cityInput.value = city;
      if (stateInput) stateInput.value = state;
      if (zipInput) zipInput.value = zip;
    });
  }

  applyAddressProfile("from_profile_select", "from");
  applyAddressProfile("to_profile_select", "to");
});
</script>

{% endblock %}