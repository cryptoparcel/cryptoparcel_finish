{% extends "base.html" %}
{% block title %}Create Label - CryptoParcel{% endblock %}
{% block content %}
<section class="cp-inner">
  <div class="container">
    <div style="text-align: center; margin-bottom: 48px;">
      <h1>Create a Shipping Label</h1>
      <p>Fast crypto payments. Real labels. No KYC.</p>
    </div>

    <form method="POST" class="cp-form-card">
      <!-- Shipped To -->
      <h2>Shipped To</h2>
      <div class="cp-field-group">
        <label>Recipient Name</label>
        <input type="text" name="to_name" required placeholder="Jane Smith">
      </div>

      <div class="cp-field-group">
        <label>Street Address</label>
        <input type="text" id="to_street" name="to_address" required placeholder="Start typing address..." autocomplete="off">
      </div>

      <div class="cp-field-group">
        <label>Apartment, suite, unit, etc. (optional)</label>
        <input type="text" name="to_street2" placeholder="Apt 4B">
      </div>

      <div class="cp-field-grid">
        <div class="cp-field-group">
          <label>City</label>
          <input type="text" id="to_city" name="to_city" required readonly>
        </div>
        <div class="cp-field-group">
          <label>State</label>
          <input type="text" id="to_state" name="to_state" required readonly>
        </div>
        <div class="cp-field-group">
          <label>ZIP Code</label>
          <input type="text" id="to_zip" name="to_zip" required readonly>
        </div>
      </div>

      <div class="cp-field-group">
        <label>Phone (optional)</label>
        <input type="text" name="to_phone" placeholder="+1 (555) 123-4567">
      </div>

      <!-- Shipped From -->
      <h2 style="margin-top: 48px;">Shipped From</h2>
      <div class="cp-field-group">
        <label>Name</label>
        <input type="text" name="from_name" required placeholder="John Doe">
      </div>

      <div class="cp-field-group">
        <label>Street Address</label>
        <input type="text" id="from_street" name="from_address" required placeholder="Start typing address..." autocomplete="off">
      </div>

      <div class="cp-field-group">
        <label>Apartment, suite, unit, etc. (optional)</label>
        <input type="text" name="from_street2" placeholder="Suite 200">
      </div>

      <div class="cp-field-grid">
        <div class="cp-field-group">
          <label>City</label>
          <input type="text" id="from_city" name="from_city" required readonly>
        </div>
        <div class="cp-field-group">
          <label>State</label>
          <input type="text" id="from_state" name="from_state" required readonly>
        </div>
        <div class="cp-field-group">
          <label>ZIP Code</label>
          <input type="text" id="from_zip" name="from_zip" required readonly>
        </div>
      </div>

      <div class="cp-field-group">
        <label>Phone (optional)</label>
        <input type="text" name="from_phone" placeholder="+1 (555) 987-6543">
      </div>

      <!-- Package Details -->
      <h2 style="margin-top: 48px;">Package Details</h2>
      <div class="cp-field-grid">
        <div class="cp-field-group">
          <label>Carrier</label>
          <select name="carrier" id="carrier">
            <option value="USPS">USPS</option>
            <option value="UPS">UPS</option>
            <option value="FedEx">FedEx</option>
          </select>
        </div>
        <div class="cp-field-group">
          <label>Service</label>
          <select name="service" id="service" required>
            <option value="">Select service...</option>
            <optgroup label="USPS">
              <option value="USPS Ground Advantage">Ground Advantage</option>
              <option value="USPS Priority Mail">Priority Mail</option>
              <option value="USPS Priority Mail Express">Priority Mail Express</option>
            </optgroup>
            <optgroup label="UPS">
              <option value="UPS Ground">Ground</option>
              <option value="UPS 2nd Day Air">2nd Day Air</option>
              <option value="UPS Next Day Air">Next Day Air</option>
            </optgroup>
            <optgroup label="FedEx">
              <option value="FedEx Ground">Ground</option>
              <option value="FedEx 2Day">2Day</option>
              <option value="FedEx Overnight">Overnight</option>
            </optgroup>
          </select>
        </div>
      </div>

      <div class="cp-field-grid">
        <div class="cp-field-group">
          <label>Weight (oz)</label>
          <input type="number" step="0.1" name="weight_oz" id="weight_oz" required placeholder="16.0">
        </div>
        <div class="cp-field-group">
          <label>Length (in)</label>
          <input type="number" step="0.1" name="length_in" placeholder="11.0">
        </div>
        <div class="cp-field-group">
          <label>Width (in)</label>
          <input type="number" step="0.1" name="width_in" placeholder="8.0">
        </div>
        <div class="cp-field-group">
          <label>Height (in)</label>
          <input type="number" step="0.1" name="height_in" placeholder="4.0">
        </div>
      </div>

      <!-- Summary at Bottom -->
      <div style="margin-top: 48px; padding: 24px; background: var(--cp-surface-soft); border-radius: var(--cp-radius-card);">
        <h2 style="margin: 0 0 16px;">Order Summary</h2>
        <div style="display: flex; justify-content: space-between; font-size: 1.2rem; margin-bottom: 16px;">
          <span>Estimated Cost (USD)</span>
          <strong id="price-usd">$0.00</strong>
        </div>
        <div style="display: flex; justify-content: space-between; color: var(--cp-text-muted);">
          <span>Approx. in crypto (BTC)</span>
          <strong id="price-btc">—</strong>
        </div>
      </div>

      <button type="submit" class="cp-btn-large" id="submit-btn" style="margin-top: 32px;">
        <span class="btn-text">Continue to Payment</span>
        <span class="btn-spinner" style="display:none; margin-left:10px;">⟳</span>
      </button>
    </form>
  </div>
</section>

<!-- Google Places Autocomplete -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_API_KEY&libraries=places"></script>
<script>
  function initAutocomplete() {
    const options = {
      componentRestrictions: { country: "us" },
      fields: ["address_components", "geometry"],
      types: ["address"]
    };

    const toInput = document.getElementById('to_street');
    const fromInput = document.getElementById('from_street');

    const toAutocomplete = new google.maps.places.Autocomplete(toInput, options);
    const fromAutocomplete = new google.maps.places.Autocomplete(fromInput, options);

    function fillInAddress(autocomplete, prefix) {
      const place = autocomplete.getPlace();
      if (!place.address_components) return;

      let city = '', state = '', zip = '';

      for (const component of place.address_components) {
        const types = component.types;
        if (types.includes("locality")) city = component.long_name;
        if (types.includes("administrative_area_level_1")) state = component.short_name;
        if (types.includes("postal_code")) zip = component.long_name;
      }

      document.getElementById(prefix + '_city').value = city;
      document.getElementById(prefix + '_state').value = state;
      document.getElementById(prefix + '_zip').value = zip;
    }

    toAutocomplete.addListener('place_changed', () => fillInAddress(toAutocomplete, 'to'));
    fromAutocomplete.addListener('place_changed', () => fillInAddress(fromAutocomplete, 'from'));
  }

  // Price calculation
  (function() {
    const service = document.getElementById('service');
    const weightOz = document.getElementById('weight_oz');
    const usdEl = document.getElementById('price-usd');
    const btcEl = document.getElementById('price-btc');

    function update() {
      const w = parseFloat(weightOz.value) || 0;
      const s = service.value || '';

      if (!s || w <= 0) {
        usdEl.textContent = '$0.00';
        btcEl.textContent = '—';
        return;
      }

      let base = 3.0;
      if (/express|overnight|priority|next day|2day/i.test(s)) base += 2.0;
      const usd = Math.round((base + w * 0.10) * 100) / 100;

      usdEl.textContent = `$${usd.toFixed(2)}`;

      // Approximate crypto prices (hardcoded for demo — update with real API later)
      const rates = { BTC: 95000, ETH: 3300, LTC: 90 };
      const btc = (usd / rates.BTC).toFixed(6);
      btcEl.textContent = `${btc} BTC`;
    }

    [service, weightOz].forEach(el => el && el.addEventListener('change', update));
    weightOz && weightOz.addEventListener('input', () => setTimeout(update, 300));
    update();
  })();

  // Load Google Places when page loads
  window.onload = initAutocomplete;
</script>
{% endblock %}
