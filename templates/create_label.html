{% extends "base.html" %}
{% block content %}
<section class="cp-inner">
    <div class="cp-inner-header">
        <h1>Create a shipping label</h1>
        <p>
            Fill in your shipment details, choose a carrier, and pay in crypto.
            Your label will be generated as a downloadable PDF.
        </p>
    </div>

    <div class="cp-inner-layout">
        <form method="POST" action="/create-label" class="cp-form-card">
            {% if csrf_token %}
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% endif %}

            <!-- SENDER -->
            <h2>Sender</h2>
            <p class="cp-help">Where is the package shipping from?</p>

            <div class="cp-field-grid">
                <div class="cp-field-group">
                    <label>Full name</label>
                    <input type="text" name="from_name" required>
                </div>
                <div class="cp-field-group">
                    <label>Phone</label>
                    <input type="text" name="from_phone">
                </div>
            </div>

            <div class="cp-field-group">
                <label>Street address</label>
                <input type="text" name="from_address" required>
            </div>

            <div class="cp-field-grid">
                <div class="cp-field-group">
                    <label>City</label>
                    <input type="text" name="from_city" required>
                </div>
                <div class="cp-field-group">
                    <label>State</label>
                    <select name="from_state" required>
                        <option value="">Select state</option>
                        {% for state in ["AL","AK","AZ","AR","CA","CO","CT","DE","DC","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"] %}
                            <option value="{{ state }}">{{ state }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="cp-field-group">
                    <label>ZIP</label>
                    <input type="text" name="from_zip" required>
                </div>
            </div>

            <!-- RECIPIENT -->
            <h2>Recipient</h2>
            <p class="cp-help">Where is the package going?</p>

            <div class="cp-field-grid">
                <div class="cp-field-group">
                    <label>Full name</label>
                    <input type="text" name="to_name" required>
                </div>
                <div class="cp-field-group">
                    <label>Phone</label>
                    <input type="text" name="to_phone">
                </div>
            </div>

            <div class="cp-field-group">
                <label>Street address</label>
                <input type="text" name="to_address" required>
            </div>

            <div class="cp-field-grid">
                <div class="cp-field-group">
                    <label>City</label>
                    <input type="text" name="to_city" required>
                </div>
                <div class="cp-field-group">
                    <label>State</label>
                    <select name="to_state" required>
                        <option value="">Select state</option>
                        {% for state in ["AL","AK","AZ","AR","CA","CO","CT","DE","DC","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"] %}
                            <option value="{{ state }}">{{ state }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="cp-field-group">
                    <label>ZIP</label>
                    <input type="text" name="to_zip" required>
                </div>
            </div>

            <!-- PACKAGE DETAILS -->
            <h2>Package details</h2>

            <div class="cp-field-grid">
                <div class="cp-field-group">
                    <label>Weight (lb)</label>
                    <input type="number" step="0.01" name="weight_lb" id="weight_lb" required>
                    <p class="cp-help">Tip: round up to the nearest ounce.</p>
                </div>
                <div class="cp-field-group">
                    <label>Length (in)</label>
                    <input type="number" step="0.1" name="length_in">
                </div>
                <div class="cp-field-group">
                    <label>Width (in)</label>
                    <input type="number" step="0.1" name="width_in">
                </div>
                <div class="cp-field-group">
                    <label>Height (in)</label>
                    <input type="number" step="0.1" name="height_in">
                    <p class="cp-help">Dimensions are recommended for UPS/FedEx accuracy.</p>
                </div>
            </div>

            <!-- CARRIER & SERVICE -->
            <h2>Carrier &amp; service</h2>

            <div class="cp-field-grid">
                <div class="cp-field-group">
                    <label>Carrier</label>
                    <select name="carrier" id="carrier" required>
                        <option value="USPS">USPS</option>
                        <option value="UPS">UPS</option>
                        <option value="FedEx">FedEx</option>
                    </select>
                </div>

                <div class="cp-field-group">
                    <label>Shipping service</label>
                    <select name="service" id="service" required>
                        <option value="">Select service</option>

                        <optgroup label="USPS">
                            <option value="USPS Ground Advantage">USPS Ground Advantage</option>
                            <option value="USPS First-Class Package">USPS First-Class Package</option>
                            <option value="USPS Priority Mail">USPS Priority Mail</option>
                            <option value="USPS Priority Mail Express" class="usps">USPS Priority Mail Express</option>
                        </optgroup>

                        <optgroup label="UPS">
                            <option value="UPS Ground">UPS Ground</option>
                            <option value="UPS 3 Day Select">UPS 3 Day Select</option>
                            <option value="UPS 2nd Day Air" class="ups">UPS 2nd Day Air</option>
                            <option value="UPS Next Day Air Saver" class="ups">UPS Next Day Air Saver</option>
                            <option value="UPS Next Day Air" class="ups">UPS Next Day Air</option>
                        </optgroup>

                        <optgroup label="FedEx">
                            <option value="FedEx Ground">FedEx Ground</option>
                            <option value="FedEx Home Delivery">FedEx Home Delivery</option>
                            <option value="FedEx Express Saver" class="fedex">FedEx Express Saver</option>
                            <option value="FedEx 2Day" class="fedex">FedEx 2Day</option>
                            <option value="FedEx 2Day A.M." class="fedex">FedEx 2Day A.M.</option>
                            <option value="FedEx Standard Overnight" class="fedex">FedEx Standard Overnight</option>
                            <option value="FedEx Priority Overnight" class="fedex">FedEx Priority Overnight</option>
                            <option value="FedEx First Overnight" class="fedex">FedEx First Overnight</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <button type="submit" class="cp-btn-primary" id="submit-btn">
                <span class="btn-text">Continue to Payment</span>
                <span class="btn-spinner" style="display:none; margin-left:8px;">⟳</span>
            </button>
        </form>

        <!-- Sticky summary (right side) -->
        <aside class="cp-side-card cp-sticky" id="price-card">
            <div class="cp-side-section">
                <h3>Checkout summary</h3>
                <p class="muted">Estimated cost (placeholder rates)</p>

                <div class="cp-summary">
                    <div class="cp-summary-row"><span>Carrier</span><strong id="sumCarrier">—</strong></div>
                    <div class="cp-summary-row"><span>Service</span><strong id="sumService">—</strong></div>
                    <div class="cp-summary-row"><span>Weight</span><strong id="sumWeight">—</strong></div>
                    <div class="cp-summary-row cp-summary-price"><span>Estimated cost</span><strong id="price-estimate">—</strong></div>
                </div>

                <div class="cp-summary-note small">
                    Prefer faster checkout? Use your <strong>Balance</strong>.
                </div>

                <a href="/wallet/topup" class="cp-btn-secondary cp-full-width">Add funds</a>
            </div>

            <div class="cp-side-divider"></div>

            <div class="cp-side-section">
                <h3>What happens next</h3>
                <ul class="cp-side-list">
                    <li>Pay with crypto</li>
                    <li>We confirm automatically</li>
                    <li>Your PDF label is ready to download</li>
                    <li>Order saved to your account</li>
                </ul>
                <a href="/support" class="cp-btn-secondary cp-full-width">Contact support</a>
            </div>

            <p class="cp-fineprint muted">
                USPS/UPS/FedEx names are trademarks of their owners. CryptoParcel is not affiliated.
            </p>
        </aside>
    </div>
</section>

<script>
  (function () {
    const carrierEl = document.getElementById('carrier');
    const serviceEl = document.getElementById('service');
    const weightEl = document.getElementById('weight_lb');
    const sumCarrier = document.getElementById('sumCarrier');
    const sumService = document.getElementById('sumService');
    const sumWeight = document.getElementById('sumWeight');
    const estimateEl = document.getElementById('price-estimate');
    const priceCard = document.getElementById('price-card');

    function calculatePrice(service, weightLb) {
      if (!service || !weightLb || weightLb <= 0) return null;
      const weightOz = weightLb * 16;
      let basePrice = 3.0;
      const perOz = 0.10;
      const fastKeywords = ["express", "overnight", "priority", "next day", "2day", "2-day"];
      const svcLower = service.toLowerCase();
      if (fastKeywords.some(k => svcLower.includes(k))) basePrice += 2.0;
      return Math.round((basePrice + weightOz * perOz) * 100) / 100;
    }

    function updateAll() {
      // Summary fields
      sumCarrier.textContent = carrierEl?.value || '—';
      sumService.textContent = serviceEl?.value || '—';
      sumWeight.textContent = weightEl?.value ? `${weightEl.value} lb` : '—';

      // Price estimate
      const price = calculatePrice(serviceEl?.value, parseFloat(weightEl?.value));
      if (price === null) {
        estimateEl.textContent = '—';
        priceCard.classList.remove('price-card-active');
      } else {
        estimateEl.textContent = `$${price.toFixed(2)} USD`;
        estimateEl.setAttribute('aria-live', 'polite');
        priceCard.classList.add('price-card-active');
      }
    }

    [carrierEl, serviceEl, weightEl].forEach(el => el && el.addEventListener('change', updateAll));

    let weightTimeout;
    weightEl && weightEl.addEventListener('input', () => {
      clearTimeout(weightTimeout);
      weightTimeout = setTimeout(updateAll, 300);
    });

    updateAll();
  })();
</script>
{% endblock %}
